<!DOCTYPE html>
<html>
<head>
  <title>Javascript Tetris</title>
  <style>
  
	#canvas   { display: inline-block; vertical-align: top; box-shadow: 10px 10px 10px #999; border: 2px solid #333; }
	@media screen and (min-width: 0px) and (min-height: 0px)  { #canvas { width: 100px; height: 200px; } } /* 10px chunks */
	@media screen and (min-width: 300px) and (min-height: 500px)  { #canvas { width: 200px; height: 400px; } } /* 20px chunks */
	@media screen and (min-width: 400px) and (min-height: 700px)  { #canvas { width: 300px; height: 600px; } } /* 30px chunks */
	@media screen and (min-width: 500px) and (min-height: 900px)  { #canvas { width: 400px; height: 800px; } } /* 40px chunks */

   
  </style>
</head>

<body>
	<canvas id="canvas" width="400" height="800" >
	Your browser does not support the HTML5 canvas tag.
	</canvas>
  
	<script>
	
	////////////////////////////////////////////////////
	// TETRIS PIECES 
	////////////////////////////////////////////////////
	var s = { blocks : [0xC600, 0x4C80, 0xC600, 0x4C80], colour : 'red'};
	var z = { blocks : [0x6C00, 0x8C40, 0x6C00, 0x8C40], colour : 'orange'};
	var l = { blocks : [0x2E00, 0xC440, 0xE800, 0x88C0], colour : 'green'};
	var j = { blocks : [0xE200, 0xC880, 0x8E00, 0x44C0], colour : 'purple'};
	var t = { blocks : [0x0E40, 0x4640, 0x4E00, 0x4C40], colour : 'yellow'};
	var i = { blocks : [0x2222, 0x0F00, 0x4444, 0x00F0], colour : 'violet'};
	var o = { blocks : [0x0CC0, 0x0CC0, 0x0CC0, 0x0CC0], colour : 'blue'};
	
	////////////////////////////////////////////////////
	// INIT 
	////////////////////////////////////////////////////
	var canvas = document.getElementById('canvas');
	var ctx = canvas.getContext('2d');
	var nx = 10;
	var ny = 20;
	var hy = canvas.height;
	var hx = canvas.width;
	var height = hy / ny;
	var width = hx / nx;

	var map; //[y][x]
	map = new Array(ny);
	for(var y=0; y < ny ; y++) {
		initRow(map ,y , nx);
	}
	var locX;
	var locY;
	var piece = i;
	var rotation;

	
	newBlock();
	//paintGrid(ctx, nx, ny);
	//loadingScreen();
	addExceptions();

	
	
	function loadingScreen() {
		putBlockOnMap(map, o.blocks[0], -2, -1, o.colour);
		putBlockOnMap(map, t.blocks[3], -2, 2, t.colour);
		putBlockOnMap(map, l.blocks[3], -1, 0, l.colour);
		putBlockOnMap(map, z.blocks[1], -2, 4, z.colour);
		putBlockOnMap(map, s.blocks[2], 0, 5, s.colour);
		putBlockOnMap(map, i.blocks[1], 0, 6, i.colour);
		putBlockOnMap(map, j.blocks[0], 1, 3, j.colour);

		
		drawMap(ctx,nx,ny,map);
	}
	////////////////////////////////////////////////////
	// EXCEPTIONS 
	////////////////////////////////////////////////////
	
	function addExceptions()
	{
		document.addEventListener('keydown', keydown, false);
		window.addEventListener('resize', resize, false);
	}
	
	function keydown(event) {
		document.removeEventListener('keydown', keydown, false);
		
		if(event.keyCode == 40 ) {
			//down
			moveDown();
		}
		else if(event.keyCode == 39 ) {
			//right
			moveRight();
			
		}
		else if(event.keyCode == 38 ) {
			//up
			rotateLeft();
			
		}
		else if(event.keyCode == 37 ) {
			//left
			moveLeft();
			
		}
		else if(event.keyCode == 32 ) {
			//space
			while(moveDown());
			
		}
		else if(event.keyCode == 27 ) {
			//esc
			//no plans yet
		}
		
		checkLines();
		drawMap(ctx,nx,ny,map);
		document.addEventListener('keydown', keydown, false);
	}
	
	function resize(event){
		drawMap(ctx,nx,ny,map);
	}
	
	////////////////////////////////////////////////////
	// ACTIONS 
	////////////////////////////////////////////////////	
	
	
	// TODO
	// takeblock -> checkblock -> addblock
	
	function moveLeft() {
		takeBlockFromMap(map, piece.blocks[rotation], locY, locX, piece.colour);
		if(checkBlockOnMap(map, piece.blocks[rotation], locY, locX - 1)) {
			locX--;
		}
		putBlockOnMap(map, piece.blocks[rotation], locY, locX, piece.colour);
	}
		
	function moveRight() {
		takeBlockFromMap(map, piece.blocks[rotation], locY, locX, piece.colour);
		if(checkBlockOnMap(map, piece.blocks[rotation], locY, locX + 1)) {
			locX++;
		}
		putBlockOnMap(map, piece.blocks[rotation], locY, locX, piece.colour);	
	}
	
	function moveDown() {
		var success =  false;
		takeBlockFromMap(map, piece.blocks[rotation], locY, locX, piece.colour);
		if(checkBlockOnMap(map, piece.blocks[rotation], locY - 1, locX)) {
			locY--;
			success = true;
		}
		putBlockOnMap(map, piece.blocks[rotation], locY, locX, piece.colour);
		return success;
	}
	
	function rotateLeft() {
		takeBlockFromMap(map, piece.blocks[rotation], locY, locX, piece.colour);
		var nextRotation = rotation - 1;
		if(nextRotation < 0) {
			nextRotation = 3;
		}
		if(checkBlockOnMap(map, piece.blocks[nextRotation], locY, locX)) {
			rotation = nextRotation;
		}		
		putBlockOnMap(map, piece.blocks[rotation], locY, locX, piece.colour);
	}
	
	function rotateRight() {
		takeBlockFromMap(map, piece.blocks[rotation], locY, locX, piece.colour);
		var nextRotation = rotation + 1;
		if(nextRotation > 3) {
			nextRotation = 0;
		}
		if(checkBlockOnMap(map, piece.blocks[nextRotation], locY, locX)) {
			rotation = nextRotation;
		}		
		putBlockOnMap(map, piece.blocks[rotation], locY, locX, piece.colour);
	}
	
	function newBlock() {
		locX = 2;
		locY = 16;
		rotation = 1;	
		
		//randomize next piece
		piece = i;
		putBlockOnMap(map, piece.blocks[rotation], locY, locX, piece.colour);
		
		drawMap(ctx,nx,ny,map);
	}
	
	function checkLines() {
		for(var row = 0; row < ny; row++) {
			var removeLine = true;
			for(var column =0; column < nx; column++) {
				if(!map[row][column].occupied) {
					removeLine = false
				}
			}
			if(removeLine == true) {
				clearLine(map,ny ,row, 1);
			}
		}
	}
	
	////////////////////////////////////////////////////
	// MAPPING 
	////////////////////////////////////////////////////
	
	function initRow(map ,row , nx) {
		map[row] = new Array(nx);
		for(var column =0; column < nx; column++) {
			map[row][column] = {occupied : false, colour : 'white'};
		}
	}
				
	function clearMap(map, nx, ny) {
		clearLine(map,ny ,0, ny);
	}
	
	function clearLine(map,ny ,y, n) {
		for(var line = y; line < ny; line++) {
			if(line+ n < nx) {
				map[line] = map[line+n];
			}
			else {
				initRow(map ,line , nx);
			}
		}
	}
	
	function checkBlockOnMap(map, block, y, x) {
		var row = 3, column = 0;
		console.log(y, x);
		for(var mask = 0x8000;  mask > 0;  mask = mask >> 1 )
		{
			if(block & mask) {
				if(y+row < 0 || y+row >= ny || x+column < 0 || x+column >= nx ) {
					return false;	
				}
				else if(map[y+row][x+column].occupied) {
					return false;	
				}				
			}			
			if(--row == -1) {
				row = 3;
				column++;
			}
		}
		return true;
	}
	
	function putBlockOnMap(map, block, y, x, colour) {
		var row = 3, column = 0;
		for(var mask = 0x8000;  mask > 0;  mask = mask >> 1 )
		{
			if(block & mask) {
				map[y+row][x+column].occupied = true;
				map[y+row][x+column].colour = colour;	
			}
			
			if(--row == -1) {
				row = 3;
				column++;
			}
		}
	}
	
	function takeBlockFromMap(map, block, y, x) {
		var row = 3, column = 0;
		for(var mask = 0x8000;  mask > 0;  mask = mask >> 1 )
		{
			if(block & mask) {
				map[y+row][x+column].occupied = false;
				map[y+row][x+column].colour = 'white';	
			}
			
			if(--row == -1) {
				row = 3;
				column++;
			}
		}
	}
	
	////////////////////////////////////////////////////
	// DISPLAY 
	////////////////////////////////////////////////////	
	
	function paintGrid(ctx, nx, ny) {
		for(var row =0; row < ny; row++) {
			for(var column =0; column < nx; column++) {
				drawBox(ctx, row, column, 'white');
			}
		}
	}
	
	function drawMap(ctx, nx, ny, map) {
		ctx.clearRect(0, 0, hx, hy);
		for(var row =0; row < ny; row++) {
			for(var column =0; column < nx; column++) {
				if(map[row][column].occupied) {
					drawBox(ctx, row, column, map[row][column].colour);
				}
			}
		}
	}
	
	// (0,0) is top left.
	// i would prefer it to be bottom left
	//hence ny-1-y instead of y
	function drawBox (ctx, y, x, colour) {
		ctx.fillStyle = colour;
		ctx.fillRect(x*width, (ny-1-y)*height, width, height );
		ctx.strokeRect(x*width, (ny-1-y)*height, width, height );
	}
	
	</script>
  
</body>
</html>