<!DOCTYPE html>
<html>
<head>
  <title>Javascript Tetris</title>
  <style>
  
	#canvas   { display: inline-block; vertical-align: top; box-shadow: 10px 10px 10px #999; border: 2px solid #333; }
	@media screen and (min-width: 0px) and (min-height: 0px)  { #canvas { width: 100px; height: 200px; } } /* 10px chunks */
	@media screen and (min-width: 300px) and (min-height: 500px)  { #canvas { width: 200px; height: 400px; } } /* 20px chunks */
	@media screen and (min-width: 400px) and (min-height: 700px)  { #canvas { width: 300px; height: 600px; } } /* 30px chunks */
	@media screen and (min-width: 500px) and (min-height: 900px)  { #canvas { width: 400px; height: 800px; } } /* 40px chunks */

   
  </style>
</head>

<body>
	<canvas id="canvas" width="400" height="800" >
	Your browser does not support the HTML5 canvas tag.
	</canvas>
  
	<script>
	////////////////////////////////////////////////////
	// INIT 
	////////////////////////////////////////////////////
	
	var s = { blocks : [0x1320, 0x6300, 0x2640, 0x0630], colour : 'red'};
	var z = { blocks : [0x2310, 0x3600, 0x4620, 0x0360], colour : 'orange'};
	var t = { blocks : [0x0720, 0x2320, 0x2700, 0x2620], colour : 'yellow'};
	var j = { blocks : [0x1700, 0x3110, 0x7400, 0x2230], colour : 'green'};
	var l = { blocks : [0x7100, 0x3220, 0x4700, 0x1130], colour : 'purple'};
	var o = { blocks : [0x3300, 0x3300, 0x3300, 0x3300], colour : 'blue'};
	var i = { blocks : [0x2222, 0x0F00, 0x4444, 0x00F0], colour : 'violet'};
	
	canvas = document.getElementById('canvas');
	var ctx = canvas.getContext('2d');
	var nx = 10;
	var ny = 20;
	var hy = canvas.height;
	var hx = canvas.width;
	var height = hy / ny;
	var width = hx / nx;
	var map; //[y][x]
	
	map = new Array(ny);
	for(var y=0; y < ny ; y++) {
		map[y] = new Array(nx);
		for(var x =0; x < nx; x++) {
			map[y][x] = {occupied : false, colour : 'white'};
		}
	}

	loadingScreen();
	
	function loadingScreen() {
		putBlockOnMap(map, s.blocks[0], 2, 1, s.colour);
		putBlockOnMap(map, z.blocks[0], 4, 0, z.colour);
		putBlockOnMap(map, t.blocks[0], 2, -1, i.colour);
		putBlockOnMap(map, j.blocks[1], 0, 0, j.colour);
		putBlockOnMap(map, l.blocks[0], 6, 0, l.colour);
		putBlockOnMap(map, o.blocks[1], 5, 2, o.colour);
		putBlockOnMap(map, i.blocks[0], 6, 1, i.colour);
		drawMap(ctx,nx,ny,map);
	}
	////////////////////////////////////////////////////
	// EXCEPTIONS 
	////////////////////////////////////////////////////
	
	function addExceptions()
	{
		document.addEventListener('keydown', keydown, false);
		window.addEventListener('resize', resize, false);
	}
	
	function keydown(event) {
		console.log(event.keyCode);
	}
	
	function resize(event){
		
	}
	
	////////////////////////////////////////////////////
	// MAPPING 
	////////////////////////////////////////////////////
	function clearMap(map, nx, ny) {
		for(var y=0; y < ny ; y++) {
			for(var x =0; x < nx; x++) {
				map[y][x].occupied = false;
				map[y][x].colour = 'white';
			}
		}
	}
	
	function clearLine(map,ny ,y, n) {
		for(var line = y; line < ny; line++) {
			if(line+ n < nx) {
				map[line] = map[line+n];
			}
			else
			{
				map[line] = new Array(nx);
				for(var column =0; column < nx; column++) {
					map[line][column] = {occupied : false, colour : 'white'};
				}
			}
		}
	}
	
	function isOccupied(map, x, y, ny , nx) {
		if(y < ny && x < nx) {
			return map[y][x].occupied;
		}
	}
	
	function putBlockOnMap(map, block, x, y, colour) {
	//require some fixing
		for(var i=3; i >= 0; i--) {
			if(block & 8) {
				console.log(y+i, x+3);
				map[y+i][x+3].occupied = true;
				map[y+i][x+3].colour = colour;
			}
			if(block & 4) {
				console.log(y+i, x+2);
				map[y+i][x+2].occupied = true;
				map[y+i][x+2].colour = colour;
			}
			if(block & 2) {
				console.log(y+i, x+1);
				map[y+i][x+1].occupied = true;
				map[y+i][x+1].colour = colour;
			}
			if(block & 1) {
				console.log(y+i, x);
				map[y+i][x].occupied = true;
				map[y+i][x].colour = colour;
			}
			block = block >> 4;
		}
	}
	
	////////////////////////////////////////////////////
	// DISPLAY 
	////////////////////////////////////////////////////	
	function drawMap(ctx, nx, ny, map) {
		ctx.clearRect(0, 0, hx, hy);
		for(var i=0; i < ny ; i++) {
			for(var j =0; j < nx; j++) {
				if(map[i][j].occupied) {
					drawBox(ctx,j,i,map[i][j].colour);
					console.log(i, j);
				}
			}
		}
	}
	
	// (0,0) is top left.
	// i would prefer it to be bottom left
	//hence ny-1-y instead of y
	function drawBox (ctx, x, y, colour) {
		ctx.fillStyle = colour;
		ctx.fillRect(x*width, (ny-1-y)*height, width, height );
		ctx.strokeRect(x*width, (ny-1-y)*height, width, height );
	}
	
	</script>
  
</body>
</html>